name: Backend CI

on:
  push:
    branches:
      - main

jobs:
  backend-ci:
    name: Backend CI Pipeline
    runs-on: self-hosted

    strategy:
      matrix:
        node-version: [22]

    steps:
    # 1Ô∏è‚É£ Checkout repository
    - name: Checkout Code
      uses: actions/checkout@v3

    # 2Ô∏è‚É£ Setup Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}

    # 3Ô∏è‚É£ Print Node.js version
    - run: node -v
    - run: npm -v

    # 4Ô∏è‚É£ Setup Environment Variables for tests
    - name: Setup Env
      run: |
        echo "MONGO_URI=${{ secrets.MONGO_URI_TEST }}" > ./backend/.env.test
        echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> ./backend/.env.test
        echo "PORT=5001" >> ./backend/.env.test

    # 5Ô∏è‚É£ Start MongoDB (if not already running)
    - name: Start MongoDB
      run: |
        sudo systemctl start mongod || echo "MongoDB already running"

    # 6Ô∏è‚É£ Install Backend dependencies
    - name: Install Backend Dependencies
      working-directory: ./backend
      run: |
        npm install --global yarn
        yarn install

    # 7Ô∏è‚É£ Run Backend Tests
    - name: Run Backend Tests
      working-directory: ./backend
      env:
        NODE_ENV: test
        MONGO_URI: ${{ secrets.MONGO_URI_TEST }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        PORT: 5001
      run: |
        echo "Running backend tests..."
        npm test

    # 8Ô∏è‚É£ Only if tests pass, build frontend
    - name: Install Frontend Dependencies & Build
      working-directory: ./frontend
      run: |
        yarn install
        yarn run build

    # 9Ô∏è‚É£ Stop any existing PM2 apps
    - name: Stop PM2 apps
      run: pm2 stop all || echo "No PM2 apps running"

    # üîü Start backend with PM2
    - name: Start PM2 Backend
      working-directory: ./backend
      run: |
        pm2 start server.js --name legal-case-manager-backend
        pm2 save

    # 1Ô∏è‚É£1Ô∏è‚É£ Restart PM2 apps (optional)
    - name: Restart PM2 apps
      run: pm2 restart all
